import{r as f,d as r,j as e,B as v,s as L}from"./index-EZVcE4NK.js";import{C as Q}from"./Card-CUfzvBst.js";import{D as V}from"./DataTable-iWaiuJ_V.js";import{V as U}from"./ViewHeader-Bz2swllQ.js";import{M as z}from"./Modal-Dywz6qs9.js";import"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";const B=({isOpen:b,onClose:O,content:g,currentUser:C,allOrganizations:w})=>{var D,I,N;const[a,j]=f.useState({title:"",description:"",type:r.VIDEO,content_url:"",embed_url:"",html_content:"",questions:[],quiz_data:"",tags:[],visibility:"org-wide",duration_sec:0,risk_tags:[],compliance:[],thumbnail_url:"",category:"",difficulty:"Intro",passing_score:70,assigned_org_ids:[],...g}),[p,x]=f.useState({question:"",options:["","","",""],correctAnswer:0}),[_,d]=f.useState(!1),u=t=>{const{name:l,value:i}=t.target,s=l==="duration_sec"||l==="passing_score"?parseInt(i,10):i;j(n=>({...n,[l]:s}))},o=(t,l)=>{j(i=>({...i,[l]:t.target.value.split(",").map(s=>s.trim())}))},A=t=>{const l=Array.from(t.target.selectedOptions,i=>i.value);j(i=>({...i,assigned_org_ids:l.includes("all")?[]:l}))},E=t=>{const{name:l,value:i}=t.target;x(s=>({...s,[l]:i}))},R=(t,l)=>{const i=[...p.options];i[t]=l,x(s=>({...s,options:i}))},k=()=>{if(p.question&&p.options.every(t=>t)){const t={...p,id:Date.now()};j(l=>({...l,questions:[...l.questions||[],t]})),x({question:"",options:["","","",""],correctAnswer:0})}else alert("Please fill out the question and all four options.")},S=t=>{j(l=>{var i;return{...l,questions:(i=l.questions)==null?void 0:i.filter(s=>s.id!==t)}})},y=async t=>{var s;t.preventDefault(),d(!0);const l={...a,creator_id:C.id,quiz_data:a.type===r.CYBER_SECURITY_TRAINING&&(((s=a.questions)==null?void 0:s.length)??0)>0?JSON.stringify(a.questions):a.quiz_data};let i;if(g!=null&&g.id){const{error:n}=await L.from("content").update(l).eq("id",g.id);i=n}else{const{error:n}=await L.from("content").insert(l);i=n}i?alert(`Error saving content: ${i.message}`):O(),d(!1)},T=a.type===r.VIDEO_QUIZ||a.type===r.QUIZ||a.type===r.CYBER_SECURITY_TRAINING;return e.jsx(z,{isOpen:b,onClose:O,title:g?"Edit Content":"Add New Content",size:"2xl",children:e.jsxs("form",{onSubmit:y,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("label",{className:"form-control w-full",children:[e.jsx("div",{className:"label",children:e.jsx("span",{className:"label-text",children:"Title"})}),e.jsx("input",{name:"title",value:a.title,onChange:u,className:"input input-bordered w-full",required:!0})]}),e.jsxs("label",{className:"form-control w-full",children:[e.jsx("div",{className:"label",children:e.jsx("span",{className:"label-text",children:"Content Type"})}),e.jsx("select",{name:"type",value:a.type,onChange:u,className:"select select-bordered",required:!0,children:Object.values(r).map(t=>e.jsx("option",{value:t,children:t},t))})]})]}),e.jsxs("label",{className:"form-control w-full",children:[e.jsx("div",{className:"label",children:e.jsx("span",{className:"label-text",children:"Description"})}),e.jsx("textarea",{name:"description",value:a.description,onChange:u,className:"textarea textarea-bordered"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("label",{className:"form-control w-full",children:[e.jsx("div",{className:"label",children:e.jsx("span",{className:"label-text",children:"Category"})}),e.jsx("input",{name:"category",value:a.category,onChange:u,className:"input input-bordered w-full",placeholder:"e.g., Phishing, Compliance"})]}),e.jsxs("label",{className:"form-control w-full",children:[e.jsx("div",{className:"label",children:e.jsx("span",{className:"label-text",children:"Difficulty"})}),e.jsxs("select",{name:"difficulty",value:a.difficulty,onChange:u,className:"select select-bordered",children:[e.jsx("option",{value:"Intro",children:"Intro"}),e.jsx("option",{value:"Intermediate",children:"Intermediate"}),e.jsx("option",{value:"Advanced",children:"Advanced"})]})]})]}),a.type===r.HTML&&e.jsxs("label",{className:"form-control w-full",children:[e.jsx("div",{className:"label",children:e.jsx("span",{className:"label-text",children:"HTML Content"})}),e.jsx("textarea",{name:"html_content",value:a.html_content,onChange:u,className:"textarea textarea-bordered font-mono",rows:10})]}),a.type===r.CYBER_SECURITY_TRAINING&&e.jsxs("label",{className:"form-control w-full",children:[e.jsx("div",{className:"label",children:e.jsx("span",{className:"label-text",children:"Video URL (e.g., Supabase Storage)"})}),e.jsx("input",{name:"content_url",value:a.content_url,onChange:u,className:"input input-bordered w-full",placeholder:"https://..."})]}),([r.VIDEO,r.VIDEO_QUIZ].includes(a.type)||[r.PDF,r.SCORM,r.HTML5,r.REACT_SANDBOX].includes(a.type))&&e.jsxs("label",{className:"form-control w-full",children:[e.jsx("div",{className:"label",children:e.jsx("span",{className:"label-text",children:[r.PDF,r.SCORM,r.HTML5,r.REACT_SANDBOX].includes(a.type)?"Embed URL":"Content URL"})}),e.jsx("input",{name:[r.PDF,r.SCORM,r.HTML5,r.REACT_SANDBOX].includes(a.type)?"embed_url":"content_url",value:a.embed_url||a.content_url,onChange:u,className:"input input-bordered w-full"})]}),T&&e.jsxs("div",{className:"p-4 border border-base-300 rounded-lg space-y-4",children:[e.jsx("h3",{className:"font-semibold text-lg",children:"Quiz Questions"}),e.jsx("div",{className:"max-h-60 overflow-y-auto space-y-2 pr-2",children:(D=a.questions)==null?void 0:D.map((t,l)=>e.jsxs("div",{className:"bg-base-300/50 p-2 rounded-md",children:[e.jsxs("p",{className:"text-sm font-semibold flex justify-between",children:[e.jsxs("span",{children:[l+1,". ",t.question]}),e.jsx("button",{type:"button",onClick:()=>S(t.id),className:"text-error hover:opacity-80",children:"Ã—"})]}),e.jsx("ul",{className:"text-xs list-disc pl-5",children:t.options.map((i,s)=>e.jsx("li",{className:s===t.correctAnswer?"font-bold text-success":"",children:i},s))})]},t.id))}),e.jsxs("div",{className:"space-y-2 pt-4 border-t border-base-300",children:[e.jsx("h4",{className:"font-semibold",children:"Add New Question"}),e.jsx("textarea",{name:"question",value:p.question,onChange:E,placeholder:"Question text (can be HTML)",className:"textarea textarea-bordered w-full"}),p.options.map((t,l)=>e.jsx("input",{value:t,onChange:i=>R(l,i.target.value),placeholder:`Option ${l+1}`,className:"input input-bordered w-full"},l)),e.jsx("select",{name:"correctAnswer",value:p.correctAnswer,onChange:t=>x(l=>({...l,correctAnswer:parseInt(t.target.value)})),className:"select select-bordered w-full",children:p.options.map((t,l)=>e.jsxs("option",{value:l,children:["Option ",l+1," is correct"]},l))}),e.jsx(v,{type:"button",variant:"secondary",onClick:k,children:"Add Question"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("label",{className:"form-control w-full",children:[e.jsx("div",{className:"label",children:e.jsx("span",{className:"label-text",children:"Tags (comma-separated)"})}),e.jsx("input",{name:"tags",value:(I=a.tags)==null?void 0:I.join(", "),onChange:t=>o(t,"tags"),className:"input input-bordered w-full"})]}),e.jsxs("label",{className:"form-control w-full",children:[e.jsx("div",{className:"label",children:e.jsx("span",{className:"label-text",children:"Thumbnail URL"})}),e.jsx("input",{name:"thumbnail_url",value:a.thumbnail_url,onChange:u,className:"input input-bordered w-full"})]}),e.jsxs("label",{className:"form-control w-full",children:[e.jsx("div",{className:"label",children:e.jsx("span",{className:"label-text",children:"Duration (seconds)"})}),e.jsx("input",{type:"number",name:"duration_sec",value:a.duration_sec,onChange:u,className:"input input-bordered w-full"})]}),T&&e.jsxs("label",{className:"form-control w-full",children:[e.jsx("div",{className:"label",children:e.jsx("span",{className:"label-text",children:"Passing Score (%)"})}),e.jsx("input",{type:"number",name:"passing_score",value:a.passing_score,onChange:u,className:"input input-bordered w-full"})]})]}),e.jsxs("label",{className:"form-control w-full",children:[e.jsx("div",{className:"label",children:e.jsx("span",{className:"label-text",children:"Assign to Organizations"})}),e.jsxs("select",{multiple:!0,name:"assigned_org_ids",value:((N=a.assigned_org_ids)==null?void 0:N.length)===0?["all"]:a.assigned_org_ids,onChange:A,className:"select select-bordered h-32",children:[e.jsx("option",{value:"all",children:"All Organizations"}),w.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsx("div",{className:"label",children:e.jsx("span",{className:"label-text-alt",children:"Hold Ctrl/Cmd to select multiple. Selecting 'All Organizations' will override other selections."})})]}),e.jsx("div",{className:"flex justify-end pt-4",children:e.jsx(v,{type:"submit",disabled:_,children:_?e.jsx("span",{className:"loading loading-spinner"}):"Save Content"})})]})})},G=({content:b,setContent:O,currentUser:g,allOrganizations:C})=>{const[w,a]=f.useState(!1),[j,p]=f.useState(null),[x,_]=f.useState(""),[d,u]=f.useState({category:"All",difficulty:"All",type:"All"}),[o,A]=f.useState({key:"created_at",direction:"descending"}),E=f.useMemo(()=>["All",...Array.from(new Set(b.map(s=>s.category).filter(Boolean)))],[b]),R=["All","Intro","Intermediate","Advanced"],k=["All",...Object.values(r)],S={Intro:1,Intermediate:2,Advanced:3},y=s=>{const{name:n,value:m}=s.target;n==="searchTerm"?_(m):u(c=>({...c,[n]:m}))},T=s=>{let n="ascending";o&&o.key===s&&o.direction==="ascending"&&(n="descending"),A({key:s,direction:n})},D=s=>{const[n,m]=s.target.value.split("-");A({key:n,direction:m})},I=f.useMemo(()=>{let s=[...b];if(d.category!=="All"&&(s=s.filter(n=>n.category===d.category)),d.difficulty!=="All"&&(s=s.filter(n=>n.difficulty===d.difficulty)),d.type!=="All"&&(s=s.filter(n=>n.type===d.type)),x){const n=x.toLowerCase();s=s.filter(m=>m.title.toLowerCase().includes(n)||m.description.toLowerCase().includes(n))}return o&&s.sort((n,m)=>{if(o.key==="difficulty"){const q=S[n.difficulty],M=S[m.difficulty];return q===void 0?1:M===void 0?-1:o.direction==="ascending"?q-M:M-q}const c=n[o.key],h=m[o.key];return c==null?1:h==null?-1:typeof c=="number"&&typeof h=="number"?o.direction==="ascending"?c-h:h-c:typeof c=="string"&&typeof h=="string"?o.direction==="ascending"?c.localeCompare(h):h.localeCompare(c):0}),s},[b,d,x,o]),N=(s=null)=>{p(s),a(!0)},t=()=>{p(null),a(!1)},l=async s=>{if(window.confirm("Are you sure you want to delete this content? This action cannot be undone.")){const{error:n}=await L.from("content").delete().eq("id",s);n&&alert(`Error: ${n.message}`)}},i=[{key:"title",header:"Title",sortable:!0},{key:"type",header:"Type",sortable:!0},{key:"category",header:"Category",sortable:!0},{key:"difficulty",header:"Difficulty",sortable:!0},{key:"created_at",header:"Date Added",sortable:!0,render:s=>new Date(s.created_at).toLocaleDateString()},{key:"duration_sec",header:"Duration (sec)",sortable:!0},{key:"assigned_org_ids",header:"Assigned Orgs",render:s=>{var n;return e.jsx("div",{className:"flex flex-wrap gap-1",children:((n=s.assigned_org_ids)==null?void 0:n.map(m=>{const c=C.find(h=>h.id===m);return e.jsx("span",{className:"badge badge-neutral badge-sm",children:(c==null?void 0:c.name)||"Unknown Org"},m)}))||e.jsx("span",{className:"text-xs opacity-70",children:"All"})})}}];return e.jsxs("div",{className:"animate-fade-in",children:[e.jsx(U,{title:"Content Management",subtitle:"Create, edit, and manage all learning materials.",children:e.jsx(v,{onClick:()=>N(),children:"Add New Content"})}),e.jsx(Q,{className:"mb-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4",children:[e.jsx("input",{name:"searchTerm",value:x,onChange:y,className:"input input-bordered w-full",placeholder:"Search title or description..."}),e.jsx("select",{name:"category",value:d.category,onChange:y,className:"select select-bordered w-full",children:E.map(s=>e.jsx("option",{value:s,children:s},s))}),e.jsx("select",{name:"difficulty",value:d.difficulty,onChange:y,className:"select select-bordered w-full",children:R.map(s=>e.jsx("option",{value:s,children:s},s))}),e.jsx("select",{name:"type",value:d.type,onChange:y,className:"select select-bordered w-full",children:k.map(s=>e.jsx("option",{value:s,children:s},s))}),e.jsxs("select",{name:"sortBy",value:o?`${o.key}-${o.direction}`:"created_at-descending",onChange:D,className:"select select-bordered w-full",children:[e.jsx("option",{value:"created_at-descending",children:"Recently Added"}),e.jsx("option",{value:"created_at-ascending",children:"Oldest First"}),e.jsx("option",{value:"title-ascending",children:"Title (A-Z)"}),e.jsx("option",{value:"title-descending",children:"Title (Z-A)"}),e.jsx("option",{value:"difficulty-ascending",children:"Difficulty (Easy to Hard)"}),e.jsx("option",{value:"difficulty-descending",children:"Difficulty (Hard to Easy)"})]})]})}),e.jsx(V,{columns:i,data:I,sortConfig:o,onSort:T,renderActions:s=>e.jsxs("div",{className:"space-x-2",children:[e.jsx(v,{variant:"ghost",size:"sm",onClick:()=>N(s),children:"Edit"}),e.jsx(v,{variant:"danger",size:"sm",onClick:()=>l(s.id),children:"Delete"})]})}),w&&e.jsx(B,{isOpen:w,onClose:t,content:j,currentUser:g,allOrganizations:C})]})};export{G as default};
