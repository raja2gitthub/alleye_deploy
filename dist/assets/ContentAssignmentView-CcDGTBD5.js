import{r as h,j as s,B as _,s as $,d as L}from"./index-EZVcE4NK.js";import{V as z}from"./ViewHeader-C_f75zHr.js";import{C as F}from"./Card-CUfzvBst.js";import{D as M}from"./DataTable-iWaiuJ_V.js";import{M as V}from"./Modal-Dywz6qs9.js";import"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";const q=({isOpen:y,onClose:x,item:o,users:v,teams:A,assignments:b})=>{const[p,f]=h.useState(new Set);h.useEffect(()=>{y&&f(new Set(b.map(r=>r.user_id)))},[y,b]);const S=r=>{f(i=>{const c=new Set(i);return c.has(r)?c.delete(r):c.add(r),c})},l=r=>{const i=v.filter(t=>t.team===r).map(t=>t.id),c=i.length>0&&i.every(t=>p.has(t));f(t=>{const j=new Set(t);return c?i.forEach(a=>j.delete(a)):i.forEach(a=>j.add(a)),j})},C=async r=>{r.preventDefault();const i="contentIds"in o,c=o.id,t=i?"playlist_id":"content_id",j=p,a=new Set(b.map(m=>m.user_id)),T=[...j].filter(m=>!a.has(m)),I=[...a].filter(m=>!j.has(m)),k=[];if(T.length>0){const m=T.map(U=>({user_id:U,[t]:c}));k.push($.from("user_assignments").insert(m))}if(I.length>0&&k.push($.from("user_assignments").delete().eq(t,c).in("user_id",I)),k.length===0){x();return}const w=(await Promise.all(k)).map(m=>m.error).filter(Boolean);w.length>0?alert(`An error occurred: ${w.map(m=>m.message).join(", ")}`):(alert("Assignments updated successfully!"),x())},N="contentIds"in o;return s.jsx(V,{isOpen:y,onClose:x,title:`Manage Assignments for: ${N?o.name:o.title}`,children:s.jsxs("form",{onSubmit:C,children:[s.jsx("h3",{className:"font-semibold mb-2",children:"Assign to Teams"}),s.jsx("div",{className:"max-h-40 overflow-y-auto border border-border p-2 rounded-md mb-4",children:A.map(r=>{const i=v.filter(t=>t.team===r.id).map(t=>t.id),c=i.length>0&&i.every(t=>p.has(t));return s.jsxs("label",{className:"flex items-center p-2 rounded-md hover:bg-sidebar-accent cursor-pointer",children:[s.jsx("input",{type:"checkbox",checked:c,onChange:()=>l(r.id),className:"h-4 w-4 rounded"}),s.jsx("span",{className:"ml-3 text-text-secondary",children:r.name})]},r.id)})}),s.jsx("h3",{className:"font-semibold mb-2",children:"Assign to Individual Users"}),s.jsx("div",{className:"max-h-60 overflow-y-auto border border-border p-2 rounded-md",children:v.map(r=>s.jsxs("label",{className:"flex items-center p-2 rounded-md hover:bg-sidebar-accent cursor-pointer",children:[s.jsx("input",{type:"checkbox",checked:p.has(r.id),onChange:()=>S(r.id),className:"h-4 w-4 rounded"}),s.jsx("span",{className:"ml-3 text-text-secondary",children:r.name})]},r.id))}),s.jsx("div",{className:"flex justify-end pt-4 mt-4 border-t border-border",children:s.jsx(_,{type:"submit",children:"Update Assignments"})})]})})},H=({value:y})=>s.jsx("div",{className:"w-full bg-sidebar-accent rounded-full h-2.5",children:s.jsx("div",{className:"bg-primary h-2.5 rounded-full",style:{width:`${y}%`}})}),O=({isOpen:y,onClose:x,playlist:o,users:v,userAssignments:A})=>{if(!o)return null;const b=h.useMemo(()=>{const f=new Set(A.filter(l=>l.playlist_id===o.id).map(l=>l.user_id));return v.filter(l=>f.has(l.id)).map(l=>{const C=o.contentIds.filter(r=>{var i,c;return((c=(i=l.progress)==null?void 0:i[r])==null?void 0:c.status)==="completed"}).length,N=o.contentIds.length>0?Math.round(C/o.contentIds.length*100):0;return{id:l.id,name:l.name,progress:N}})},[o,v,A]),p=[{key:"name",header:"User"},{key:"progress",header:"Completion Progress",render:f=>s.jsxs("div",{className:"flex items-center gap-4",children:[s.jsx(H,{value:f.progress}),s.jsxs("span",{className:"text-sm font-semibold w-12 text-right",children:[f.progress,"%"]})]})}];return s.jsx(V,{isOpen:y,onClose:x,title:`Activity for "${o.name}"`,size:"lg",children:s.jsx(M,{columns:p,data:b})})},X=({users:y,content:x,playlists:o,currentUser:v,teams:A,userAssignments:b,initialView:p="content"})=>{const[f,S]=h.useState(p),[l,C]=h.useState(null),[N,r]=h.useState(null),[i,c]=h.useState(""),[t,j]=h.useState({category:"All",difficulty:"All",type:"All"}),[a,T]=h.useState({key:"title",direction:"ascending"});h.useEffect(()=>{S(p),T({key:p==="content"?"title":"name",direction:"ascending"})},[p]);const I=h.useMemo(()=>["All",...Array.from(new Set(x.map(e=>e.category).filter(Boolean)))],[x]),k=["All","Intro","Intermediate","Advanced"],P=["All",...Object.values(L)],w=e=>{const{name:n,value:d}=e.target;n==="searchTerm"?c(d):j(u=>({...u,[n]:d}))},m=e=>{let n="ascending";a&&a.key===e&&a.direction==="ascending"&&(n="descending"),T({key:e,direction:n})},U=h.useMemo(()=>{let e=[...x];if(t.category!=="All"&&(e=e.filter(n=>n.category===t.category)),t.difficulty!=="All"&&(e=e.filter(n=>n.difficulty===t.difficulty)),t.type!=="All"&&(e=e.filter(n=>n.type===t.type)),i){const n=i.toLowerCase();e=e.filter(d=>d.title.toLowerCase().includes(n))}return a&&e.sort((n,d)=>{const u=n[a.key],g=d[a.key];return u==null?1:g==null?-1:typeof u=="number"&&typeof g=="number"?a.direction==="ascending"?u-g:g-u:typeof u=="string"&&typeof g=="string"?a.direction==="ascending"?u.localeCompare(g):g.localeCompare(u):0}),e},[x,t,i,a]),D=h.useMemo(()=>{let e=[...o];if(i){const n=i.toLowerCase();e=e.filter(d=>d.name.toLowerCase().includes(n)||d.description.toLowerCase().includes(n))}return a&&e.sort((n,d)=>{const u=n[a.key],g=d[a.key];return typeof u=="string"&&typeof g=="string"?a.direction==="ascending"?u.localeCompare(g):g.localeCompare(u):0}),e},[o,i,a]),E=[{key:"title",header:"Title",sortable:!0},{key:"type",header:"Type",sortable:!0},{key:"passing_score",header:"Passing Score",sortable:!0,render:e=>e.passing_score?`${e.passing_score}%`:"N/A"},{key:"category",header:"Category",sortable:!0},{key:"difficulty",header:"Difficulty",sortable:!0},{key:"assignedCount",header:"Assigned To",render:e=>{const n=b.filter(d=>d.content_id===e.id).length;return`${n} user${n===1?"":"s"}`}}],B=[{key:"name",header:"Playlist Name",sortable:!0},{key:"description",header:"Description",sortable:!0},{key:"assignedCount",header:"Assigned To",render:e=>{const n=b.filter(d=>d.playlist_id===e.id).length;return`${n} user${n===1?"":"s"}`}}];return s.jsxs("div",{className:"animate-fade-in",children:[s.jsx(z,{title:"Assign Training",subtitle:"Assign content or playlists to your teams and users."}),s.jsxs(F,{className:"mb-6",children:[s.jsxs("div",{role:"tablist",className:"tabs tabs-bordered",children:[s.jsx("a",{role:"tab",className:`tab ${f==="content"?"tab-active":""}`,onClick:()=>S("content"),children:"Content"}),s.jsx("a",{role:"tab",className:`tab ${f==="playlists"?"tab-active":""}`,onClick:()=>S("playlists"),children:"Playlists"})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 pt-4",children:[s.jsx("input",{name:"searchTerm",value:i,onChange:w,className:"input input-bordered w-full",placeholder:"Search..."}),f==="content"&&s.jsxs(s.Fragment,{children:[s.jsx("select",{name:"category",value:t.category,onChange:w,className:"select select-bordered w-full",children:I.map(e=>s.jsx("option",{value:e,children:e},e))}),s.jsx("select",{name:"difficulty",value:t.difficulty,onChange:w,className:"select select-bordered w-full",children:k.map(e=>s.jsx("option",{value:e,children:e},e))}),s.jsx("select",{name:"type",value:t.type,onChange:w,className:"select select-bordered w-full",children:P.map(e=>s.jsx("option",{value:e,children:e},e))})]})]})]}),f==="content"?s.jsx(M,{columns:E,data:U,sortConfig:a,onSort:m,renderActions:e=>s.jsx(_,{variant:"secondary",size:"sm",onClick:()=>C(e),children:"Manage"})}):s.jsx(M,{columns:B,data:D,sortConfig:a,onSort:m,renderActions:e=>s.jsxs("div",{className:"space-x-2",children:[s.jsx(_,{variant:"ghost",size:"sm",onClick:()=>r(e),children:"View Activity"}),s.jsx(_,{variant:"secondary",size:"sm",onClick:()=>C(e),children:"Manage"})]})}),l&&s.jsx(q,{isOpen:!!l,onClose:()=>C(null),item:l,users:y,teams:A,assignments:b.filter(e=>"contentIds"in l?e.playlist_id===l.id:e.content_id===l.id)}),s.jsx(O,{isOpen:!!N,onClose:()=>r(null),playlist:N,users:y,userAssignments:b})]})};export{X as default};
