import{r as i,j as e,B as F}from"./index-EZVcE4NK.js";import{V as K}from"./ViewHeader-C_f75zHr.js";import{f as R}from"./xapiLrsClient-D85D4vVW.js";import{C as u}from"./Card-CUfzvBst.js";import{R as P,T as I}from"./CategoricalChart-DwX3OCgn.js";import{L as M,a as $}from"./LineChart-BDE7GRgA.js";import{C as T,L as B}from"./CartesianGrid-ByPxxI5E.js";import{X as O}from"./XAxis-Bu-EbL_O.js";import{Y as U}from"./YAxis-DpvTBbGr.js";import{P as V,a as _}from"./PieChart-Qk7a3gMm.js";import{C as X}from"./CartesianChart-DXJYFoJy.js";import{B as H}from"./BarChart-P8VKVkVQ.js";import{B as z}from"./barSelectors-C7tPt0tT.js";import{D as Y}from"./DataTable-iWaiuJ_V.js";import"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";import"./ActivePoints-DLfukH-g.js";import"./ErrorBarContext-DMcmVl1c.js";import"./getRadiusAndStrokeWidthFromDot-NW7TPI2l.js";import"./PolarChart-DFVWZZVg.js";const G=({orgUsers:m,allContent:j})=>{const g=i.useRef(null),[n,y]=i.useState([]),[N,p]=i.useState(!0),[b,c]=i.useState("30"),[l,S]=i.useState("all"),[f,h]=i.useState("all");i.useEffect(()=>{(async()=>{p(!0);const r=new Date;r.setDate(r.getDate()-parseInt(b));const s={since:r.toISOString()};if(l!=="all"){const d=m.find(v=>v.id===l);d&&(s.agent=d)}if(f!=="all"){const d=j.find(v=>v.id===parseInt(f));d&&(s.activity=d)}const a=await R(s);let o=a;if(l==="all"){const d=new Set(m.map(v=>`mailto:${v.email}`));o=a.filter(v=>d.has(v.actor.mbox))}y(o),p(!1)})()},[b,l,f,m,j]);const w=i.useMemo(()=>{const t=new Set(n.map(a=>a.actor.mbox)).size,r=n.filter(a=>{var o,d;return((d=(o=a.result)==null?void 0:o.score)==null?void 0:d.raw)!==void 0}).map(a=>a.result.score.raw),s=r.length>0?r.reduce((a,o)=>a+o,0)/r.length:0;return{totalStatements:n.length,activeLearners:t,averageScore:s}},[n]),A=i.useMemo(()=>{const t={};return n.forEach(r=>{const s=new Date(r.timestamp).toLocaleDateString("en-US",{month:"short",day:"numeric"});t[s]||(t[s]={date:s,Launched:0,Completed:0}),r.verb.id.includes("launched")&&t[s].Launched++,r.verb.id.includes("completed")&&t[s].Completed++}),Object.values(t).sort((r,s)=>new Date(r.date).getTime()-new Date(s.date).getTime())},[n]),C=i.useMemo(()=>{const t={desktop:0,mobile:0,unknown:0};return n.forEach(r=>{var a,o;const s=((o=(a=r.context)==null?void 0:a.extensions)==null?void 0:o["https://w3id.org/xapi/acrossx/extensions/device-type"])||"unknown";t[s]!==void 0?t[s]++:t.unknown++}),Object.entries(t).map(([r,s])=>({name:r,value:s}))},[n]),k=i.useMemo(()=>{const t=[{name:"0-20",count:0},{name:"21-40",count:0},{name:"41-60",count:0},{name:"61-80",count:0},{name:"81-100",count:0}];return n.forEach(r=>{var s,a;if(((a=(s=r.result)==null?void 0:s.score)==null?void 0:a.raw)!==void 0){const o=r.result.score.raw;o<=20?t[0].count++:o<=40?t[1].count++:o<=60?t[2].count++:o<=80?t[3].count++:t[4].count++}}),t},[n]),D=i.useMemo(()=>{const t={};n.forEach(s=>{var o,d;const a=(o=s.object)==null?void 0:o.id;!a||!((d=s.verb)!=null&&d.id)||(t[a]||(t[a]={launches:0,completions:0}),s.verb.id.includes("launched")&&t[a].launches++,s.verb.id.includes("completed")&&t[a].completions++)});const r=Object.entries(t).map(([s,a])=>{const o=j.find(d=>`https://lms.example.com/content/${d.id}`===s);return{title:(o==null?void 0:o.title)||"Unknown Content",rate:a.launches>0?a.completions/a.launches*100:0}});return{mostCompleted:[...r].sort((s,a)=>a.rate-s.rate).slice(0,6),leastCompleted:[...r].filter(s=>s.rate<100).sort((s,a)=>s.rate-a.rate).slice(0,6)}},[n,j]),L=()=>{},x=()=>{},E=["#8884d8","#ffc658","#82ca9d"];return N?e.jsx("div",{children:"Loading dashboard..."}):e.jsxs("div",{ref:g,className:"space-y-6 bg-background p-1",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold text-text-main",children:"xAPI Analytics Dashboard"}),e.jsx("p",{className:"text-text-secondary text-sm",children:"Deep dive into learner behavior across your organization."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:b,onChange:t=>c(t.target.value),className:"form-select text-sm",children:[e.jsx("option",{value:"30",children:"Last 30 Days"}),e.jsx("option",{value:"7",children:"Last 7 Days"}),e.jsx("option",{value:"90",children:"Last 90 Days"})]}),e.jsxs("select",{value:l,onChange:t=>S(t.target.value),className:"form-select text-sm",children:[e.jsx("option",{value:"all",children:"All Users"}),m.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("select",{value:f,onChange:t=>h(t.target.value),className:"form-select text-sm",children:[e.jsx("option",{value:"all",children:"All Content"}),j.map(t=>e.jsx("option",{value:String(t.id),children:t.title},t.id))]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(F,{onClick:x,children:"Export PDF"}),e.jsx(F,{onClick:L,children:"Export CSV"}),e.jsx(F,{variant:"ghost",onClick:()=>alert("Email sharing not implemented."),children:"Share to Email"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs(u,{className:"text-center",children:[e.jsx("p",{className:"text-text-secondary",children:"Total Statements"}),e.jsx("p",{className:"text-4xl font-bold text-text-main",children:w.totalStatements})]}),e.jsxs(u,{className:"text-center",children:[e.jsx("p",{className:"text-text-secondary",children:"Active Learners"}),e.jsx("p",{className:"text-4xl font-bold text-text-main",children:w.activeLearners})]}),e.jsxs(u,{className:"text-center",children:[e.jsx("p",{className:"text-text-secondary",children:"Average Score"}),e.jsxs("p",{className:"text-4xl font-bold text-text-main",children:[w.averageScore.toFixed(2),"%"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-5 gap-6",children:[e.jsxs(u,{className:"lg:col-span-3",children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Engagement Over Time"}),e.jsx(P,{width:"100%",height:250,children:e.jsxs(M,{data:A,children:[e.jsx(T,{strokeDasharray:"3 3",stroke:"var(--border-color)"}),e.jsx(O,{dataKey:"date",tick:{fill:"var(--text-secondary-color)",fontSize:12}}),e.jsx(U,{tick:{fill:"var(--text-secondary-color)",fontSize:12}}),e.jsx(I,{contentStyle:{backgroundColor:"var(--card-color)",border:"1px solid var(--border-color)"}}),e.jsx(B,{}),e.jsx($,{type:"monotone",dataKey:"Launched",stroke:"#8884d8"}),e.jsx($,{type:"monotone",dataKey:"Completed",stroke:"#82ca9d"})]})})]}),e.jsxs(u,{className:"lg:col-span-2",children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Device Usage"}),e.jsx(P,{width:"100%",height:250,children:e.jsxs(V,{children:[e.jsx(_,{data:C,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",outerRadius:80,label:!0,children:C.map((t,r)=>e.jsx(X,{fill:E[r%E.length]},`cell-${r}`))}),e.jsx(I,{contentStyle:{backgroundColor:"var(--card-color)",border:"1px solid var(--border-color)"}}),e.jsx(B,{})]})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(u,{children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Quiz Score Distribution"}),e.jsx(P,{width:"100%",height:250,children:e.jsxs(H,{data:k,children:[e.jsx(T,{strokeDasharray:"3 3",stroke:"var(--border-color)"}),e.jsx(O,{dataKey:"name",tick:{fill:"var(--text-secondary-color)",fontSize:12}}),e.jsx(U,{tick:{fill:"var(--text-secondary-color)",fontSize:12}}),e.jsx(I,{contentStyle:{backgroundColor:"var(--card-color)",border:"1px solid var(--border-color)"}}),e.jsx(z,{dataKey:"count",fill:"#8884d8",name:"Learners"})]})})]}),e.jsxs(u,{children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Content Hotspots"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-green-400",children:"Most Completed"}),e.jsx("ul",{className:"mt-2 space-y-1 list-disc list-inside",children:D.mostCompleted.map(t=>e.jsxs("li",{children:[" ",t.title," ",e.jsxs("span",{className:"text-text-secondary",children:["(",t.rate.toFixed(0),"%)"]})," "]},t.title))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-red-400",children:"Least Completed"}),e.jsx("ul",{className:"mt-2 space-y-1 list-disc list-inside",children:D.leastCompleted.map(t=>e.jsxs("li",{children:[" ",t.title," ",e.jsxs("span",{className:"text-text-secondary",children:["(",t.rate.toFixed(0),"%)"]})," "]},t.title))})]})]})]})]})]})},Q=({orgUsers:m,allContent:j})=>{const[g,n]=i.useState([]),[y,N]=i.useState(!1);i.useEffect(()=>{(async()=>{N(!0);const l=await R({}),S=new Set(m.map(h=>`mailto:${h.email}`)),f=l.filter(h=>S.has(h.actor.mbox));n(f),N(!1)})()},[m]);const p=()=>{var A,C,k,D,L;if(g.length===0){alert("No data to export.");return}const l=[["Timestamp","Actor Name","Actor Email","Verb","Activity Name","Activity ID","Success","Score","Response","Duration"].join(",")];for(const x of g){const E=[`"${new Date(x.timestamp).toLocaleString()}"`,`"${x.actor.name||""}"`,`"${x.actor.mbox||""}"`,`"${x.verb.display["en-US"]||x.verb.id}"`,`"${x.object.definition.name["en-US"]||""}"`,`"${x.object.id}"`,`"${((A=x.result)==null?void 0:A.success)??"N/A"}"`,`"${((k=(C=x.result)==null?void 0:C.score)==null?void 0:k.raw)??"N/A"}"`,`"${((D=x.result)==null?void 0:D.response)??""}"`,`"${((L=x.result)==null?void 0:L.duration)??"N/A"}"`];l.push(E.join(","))}const S=l.join(`
`),f=new Blob([S],{type:"text/csv;charset=utf-8;"}),h=document.createElement("a"),w=URL.createObjectURL(f);h.setAttribute("href",w),h.setAttribute("download","xapi_report.csv"),document.body.appendChild(h),h.click(),document.body.removeChild(h)},b=[{key:"actor",header:"User",render:c=>c.actor.name||c.actor.mbox},{key:"verb",header:"Action",render:c=>c.verb.display["en-US"]},{key:"object",header:"Object",render:c=>c.object.definition.name["en-US"]},{key:"timestamp",header:"Timestamp",render:c=>new Date(c.timestamp).toLocaleString()}];return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex justify-end",children:e.jsx(F,{onClick:p,children:"Export CSV"})}),y?e.jsx("div",{className:"text-center p-8",children:e.jsx("span",{className:"loading loading-lg"})}):e.jsx(Y,{columns:b,data:g.map(c=>({...c,id:c.id||Math.random()}))})]})},q=({organization:m})=>m!=null&&m.powerbi_embed_url?e.jsx(u,{className:"!p-0 overflow-hidden",style:{height:"calc(100vh - 18rem)"},children:e.jsx("iframe",{title:m.name,width:"100%",height:"100%",src:m.powerbi_embed_url,frameBorder:"0",allowFullScreen:!0})}):e.jsx(u,{children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("h2",{className:"text-xl font-bold",children:"Dashboard Not Available"}),e.jsx("p",{className:"text-text-secondary mt-2",children:"A Power BI dashboard has not been configured for your organization."})]})}),fe=({teamUsers:m,teamAnalytics:j,teamCyberAnalytics:g,allContent:n,allUsers:y,organization:N})=>{const[p,b]=i.useState("xAPI Dashboard"),c=["xAPI Dashboard","xAPI Feed","Power BI"];return e.jsxs("div",{className:"animate-fade-in space-y-8",children:[e.jsx(K,{title:"Analytics",subtitle:"Track team performance, learning activity, and business intelligence."}),e.jsx("div",{className:"flex border-b border-border",children:c.map(l=>e.jsx("button",{onClick:()=>b(l),className:`px-4 py-2 text-sm font-medium ${p===l?"border-b-2 border-primary text-primary":"text-text-secondary hover:text-text-main"}`,children:l},l))}),e.jsxs("div",{className:"mt-6",children:[p==="xAPI Dashboard"&&e.jsx(G,{orgUsers:y,allContent:n}),p==="xAPI Feed"&&e.jsx(Q,{orgUsers:y,allContent:n}),p==="Power BI"&&e.jsx(q,{organization:N})]})]})};export{fe as default};
