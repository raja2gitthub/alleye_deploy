import{r as g,R as y,j as e,B as x,s as j}from"./index-EZVcE4NK.js";import{V as O}from"./ViewHeader-Bz2swllQ.js";import{C as D}from"./Card-CUfzvBst.js";import{D as R}from"./DataTable-iWaiuJ_V.js";import{M as I}from"./Modal-Dywz6qs9.js";import"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";const $=({isOpen:u,onClose:w,user:t,organizations:z})=>{const[i,s]=g.useState({name:(t==null?void 0:t.name)||"",email:(t==null?void 0:t.email)||"",password:"",role:(t==null?void 0:t.role)||y.USER,organization_id:(t==null?void 0:t.organization_id)||"",team:(t==null?void 0:t.team)||""}),N=async n=>{if(n.preventDefault(),t){const{error:l}=await j.from("profiles").update({name:i.name,role:i.role,organization_id:i.organization_id||null,team:i.team}).eq("id",t.id);if(l){alert(`Error: ${l.message}`);return}if(i.password){const{error:c}=await j.auth.admin.updateUserById(t.id,{password:i.password});if(c){alert(`Error updating password: ${c.message}`);return}}}else{const{data:l,error:c}=await j.auth.signUp({email:i.email,password:i.password,options:{data:{name:i.name,role:i.role,organization_id:i.organization_id||null,team:i.team,points:0,badges:[],progress:{},avatar_url:`https://api.dicebear.com/8.x/initials/svg?seed=${encodeURIComponent(i.name)}`}}});if(c){alert(`Error creating user: ${c.message}`);return}}w()};return e.jsx(I,{isOpen:u,onClose:w,title:t?"Edit User":"Create User",children:e.jsxs("form",{onSubmit:N,className:"space-y-4",children:[e.jsx("input",{value:i.name,onChange:n=>s(l=>({...l,name:n.target.value})),placeholder:"Full Name",className:"form-input",required:!0}),e.jsx("input",{type:"email",value:i.email,onChange:n=>s(l=>({...l,email:n.target.value})),placeholder:"Email",className:"form-input",required:!0,disabled:!!t}),e.jsx("input",{type:"password",value:i.password,onChange:n=>s(l=>({...l,password:n.target.value})),placeholder:t?"New Password (optional)":"Password",className:"form-input",required:!t}),e.jsx("select",{value:i.role,onChange:n=>s(l=>({...l,role:n.target.value})),className:"form-select",children:Object.values(y).map(n=>e.jsx("option",{value:n,children:n},n))}),e.jsxs("select",{value:i.organization_id,onChange:n=>s(l=>({...l,organization_id:n.target.value})),className:"form-select",children:[e.jsx("option",{value:"",children:"No Organization"}),z.map(n=>e.jsx("option",{value:n.id,children:n.name},n.id))]}),e.jsx("input",{value:i.team,onChange:n=>s(l=>({...l,team:n.target.value})),placeholder:"Team Name",className:"form-input"}),e.jsx("div",{className:"flex justify-end pt-4",children:e.jsx(x,{type:"submit",children:"Save User"})})]})})},L=({users:u,setUsers:w,organizations:t,currentUser:z})=>{const[i,s]=g.useState(!1),[N,n]=g.useState(null),[l,c]=g.useState(""),[d,C]=g.useState({role:"All",organizationId:"All"}),[h,b]=g.useState({key:"created_at",direction:"descending"}),U=g.useMemo(()=>{let a=[...u];l&&(a=a.filter(o=>o.name.toLowerCase().includes(l.toLowerCase()))),d.role!=="All"&&(a=a.filter(o=>o.role===d.role)),d.organizationId!=="All"&&(d.organizationId==="none"?a=a.filter(o=>!o.organization_id):a=a.filter(o=>o.organization_id===d.organizationId));const r=new Map(t.map(o=>[o.id,o.name]));return a.sort((o,A)=>{const{key:f,direction:k}=h;let m,p;if(f==="organization"?(m=r.get(o.organization_id||"")||"",p=r.get(A.organization_id||"")||""):(m=o[f],p=A[f]),m==null)return 1;if(p==null)return-1;let v=0;return typeof m=="string"&&typeof p=="string"&&(f==="created_at"?v=new Date(m).getTime()-new Date(p).getTime():v=m.localeCompare(p)),k==="ascending"?v:-v}),a},[u,l,d,h,t]),_=(a=null)=>{n(a),s(!0)},S=()=>{n(null),s(!1)},E=async a=>{if(a===z.id){alert("You cannot delete your own account.");return}if(window.confirm("Are you sure you want to delete this user?")){const{error:r}=await j.auth.admin.deleteUser(a);r&&alert(`Error: ${r.message}`)}},M=[{key:"name",header:"Name"},{key:"email",header:"Email"},{key:"role",header:"Role"},{key:"organization_id",header:"Organization",render:a=>{var r;return((r=t.find(o=>o.id===a.organization_id))==null?void 0:r.name)||e.jsx("span",{className:"opacity-70 italic",children:"None"})}},{key:"created_at",header:"Date Added",render:a=>a.created_at?new Date(a.created_at).toLocaleString():"N/A"}];return e.jsxs("div",{className:"animate-fade-in",children:[e.jsx(O,{title:"Global User Management",subtitle:"Manage all users across all organizations.",children:e.jsx(x,{onClick:()=>_(),children:"Create User"})}),e.jsx(D,{className:"mb-6",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsx("input",{value:l,onChange:a=>c(a.target.value),className:"input input-bordered w-full",placeholder:"Search by name..."}),e.jsxs("select",{value:d.role,onChange:a=>C(r=>({...r,role:a.target.value})),className:"select select-bordered w-full",children:[e.jsx("option",{value:"All",children:"All Roles"}),Object.values(y).map(a=>e.jsx("option",{value:a,children:a},a))]}),e.jsxs("select",{value:d.organizationId,onChange:a=>C(r=>({...r,organizationId:a.target.value})),className:"select select-bordered w-full",children:[e.jsx("option",{value:"All",children:"All Organizations"}),e.jsx("option",{value:"none",children:"No Organization"}),t.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]}),e.jsxs("select",{value:`${h.key}-${h.direction}`,onChange:a=>{const[r,o]=a.target.value.split("-");b({key:r,direction:o})},className:"select select-bordered w-full",children:[e.jsx("option",{value:"created_at-descending",children:"Recently Added"}),e.jsx("option",{value:"created_at-ascending",children:"Oldest First"}),e.jsx("option",{value:"name-ascending",children:"Name (A-Z)"}),e.jsx("option",{value:"name-descending",children:"Name (Z-A)"}),e.jsx("option",{value:"role-ascending",children:"Role (A-Z)"}),e.jsx("option",{value:"role-descending",children:"Role (Z-A)"}),e.jsx("option",{value:"organization-ascending",children:"Organization (A-Z)"}),e.jsx("option",{value:"organization-descending",children:"Organization (Z-A)"})]})]})}),e.jsx(R,{columns:M,data:U,renderActions:a=>e.jsxs("div",{className:"space-x-2",children:[e.jsx(x,{variant:"ghost",size:"sm",onClick:()=>_(a),children:"Edit"}),e.jsx(x,{variant:"danger",size:"sm",onClick:()=>E(a.id),children:"Delete"})]})}),i&&e.jsx($,{isOpen:i,onClose:S,user:N,organizations:t})]})};export{L as default};
