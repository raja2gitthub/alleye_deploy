import{r as o,j as e,B as E}from"./index-EZVcE4NK.js";import{V as z}from"./ViewHeader-Bz2swllQ.js";import{f as _}from"./xapiLrsClient-D85D4vVW.js";import{C as y}from"./Card-CUfzvBst.js";import{R as P,T as $}from"./CategoricalChart-DwX3OCgn.js";import{L as X,a as B}from"./LineChart-BDE7GRgA.js";import{C as T,L as O}from"./CartesianGrid-ByPxxI5E.js";import{X as M}from"./XAxis-Bu-EbL_O.js";import{Y as V}from"./YAxis-DpvTBbGr.js";import{P as H,a as G}from"./PieChart-Qk7a3gMm.js";import{C as Y}from"./CartesianChart-DXJYFoJy.js";import{B as Q}from"./BarChart-P8VKVkVQ.js";import{B as q}from"./barSelectors-C7tPt0tT.js";import{D as J}from"./DataTable-iWaiuJ_V.js";import"https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";import"./ActivePoints-DLfukH-g.js";import"./ErrorBarContext-DMcmVl1c.js";import"./getRadiusAndStrokeWidthFromDot-NW7TPI2l.js";import"./PolarChart-DFVWZZVg.js";const W=({users:h,content:d})=>{const p=o.useRef(null),[i,m]=o.useState([]),[f,x]=o.useState(!0),[b,g]=o.useState("30"),[S,r]=o.useState("all"),[c,v]=o.useState("all");o.useEffect(()=>{(async()=>{x(!0);const a=new Date;a.setDate(a.getDate()-parseInt(b));const s={since:a.toISOString()};if(S!=="all"){const l=h.find(j=>j.id===S);l&&(s.agent=l)}if(c!=="all"){const l=d.find(j=>j.id===parseInt(c));l&&(s.activity=l)}const n=await _(s);m(n),x(!1)})()},[b,S,c,h,d]);const w=o.useMemo(()=>{const t=new Set(i.map(n=>n.actor.mbox)).size,a=i.filter(n=>{var l,j;return((j=(l=n.result)==null?void 0:l.score)==null?void 0:j.raw)!==void 0}).map(n=>n.result.score.raw),s=a.length>0?a.reduce((n,l)=>n+l,0)/a.length:0;return{totalStatements:i.length,activeLearners:t,averageScore:s}},[i]),u=o.useMemo(()=>{const t={};return i.forEach(a=>{const s=new Date(a.timestamp).toLocaleDateString("en-US",{month:"short",day:"numeric"});t[s]||(t[s]={date:s,Launched:0,Completed:0}),a.verb.id.includes("launched")&&t[s].Launched++,a.verb.id.includes("completed")&&t[s].Completed++}),Object.values(t).sort((a,s)=>new Date(a.date).getTime()-new Date(s.date).getTime())},[i]),A=o.useMemo(()=>{const t={desktop:0,mobile:0,unknown:0};return i.forEach(a=>{var n,l;const s=((l=(n=a.context)==null?void 0:n.extensions)==null?void 0:l["https://w3id.org/xapi/acrossx/extensions/device-type"])||"unknown";t[s]!==void 0?t[s]++:t.unknown++}),Object.entries(t).map(([a,s])=>({name:a,value:s}))},[i]),k=o.useMemo(()=>{const t=[{name:"0-20",count:0},{name:"21-40",count:0},{name:"41-60",count:0},{name:"61-80",count:0},{name:"81-100",count:0}];return i.forEach(a=>{var s,n;if(((n=(s=a.result)==null?void 0:s.score)==null?void 0:n.raw)!==void 0){const l=a.result.score.raw;l<=20?t[0].count++:l<=40?t[1].count++:l<=60?t[2].count++:l<=80?t[3].count++:t[4].count++}}),t},[i]),C=o.useMemo(()=>{const t={};i.forEach(s=>{var l;const n=(l=s.object)==null?void 0:l.id;n&&(t[n]||(t[n]={launches:0,completions:0}),s.verb.id.includes("launched")&&t[n].launches++,s.verb.id.includes("completed")&&t[n].completions++)});const a=Object.entries(t).map(([s,n])=>{const l=d.find(j=>`https://lms.example.com/content/${j.id}`===s);return{title:(l==null?void 0:l.title)||"Unknown Content",rate:n.launches>0?n.completions/n.launches*100:0}});return{mostCompleted:[...a].sort((s,n)=>n.rate-s.rate).slice(0,6),leastCompleted:[...a].filter(s=>s.rate<100).sort((s,n)=>s.rate-n.rate).slice(0,6)}},[i,d]),I=()=>{var l,j,F,R,U;if(i.length===0)return alert("No data to export.");const a=[["Timestamp","Actor Name","Actor Email","Verb","Activity Name","Success","Score"].join(",")];for(const N of i){const K=[`"${new Date(N.timestamp).toLocaleString()}"`,`"${N.actor.name||""}"`,`"${N.actor.mbox||""}"`,`"${N.verb.display["en-US"]||N.verb.id}"`,`"${((j=(l=N.object.definition)==null?void 0:l.name)==null?void 0:j["en-US"])||""}"`,`"${((F=N.result)==null?void 0:F.success)??"N/A"}"`,`"${((U=(R=N.result)==null?void 0:R.score)==null?void 0:U.raw)??"N/A"}"`];a.push(K.join(","))}const s=new Blob([a.join(`
`)],{type:"text/csv;charset=utf-8;"}),n=document.createElement("a");n.href=URL.createObjectURL(s),n.download="xapi_analytics.csv",n.click()},L=()=>{const t=p.current;if(!t||!window.html2canvas||!window.jspdf){alert("PDF generation library not available.");return}window.html2canvas(t,{useCORS:!0,backgroundColor:"#151515"}).then(a=>{const s=a.toDataURL("image/png"),n=new window.jspdf.jsPDF({orientation:"landscape",unit:"px",format:[a.width,a.height]});n.addImage(s,"PNG",0,0,a.width,a.height),n.save("xapi_dashboard.pdf")})},D=["#8884d8","#ffc658","#82ca9d"];return f?e.jsx("div",{children:"Loading dashboard..."}):e.jsxs("div",{ref:p,className:"space-y-6 bg-base-100 p-1",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"xAPI Analytics Dashboard"}),e.jsx("p",{className:"opacity-70 text-sm",children:"Deep dive into learner behavior across all platforms."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("select",{value:b,onChange:t=>g(t.target.value),className:"select select-bordered select-sm",children:[e.jsx("option",{value:"30",children:"Last 30 Days"}),e.jsx("option",{value:"7",children:"Last 7 Days"}),e.jsx("option",{value:"90",children:"Last 90 Days"})]}),e.jsxs("select",{value:S,onChange:t=>r(t.target.value),className:"select select-bordered select-sm",children:[e.jsx("option",{value:"all",children:"All Users"}),h.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]}),e.jsxs("select",{value:c,onChange:t=>v(t.target.value),className:"select select-bordered select-sm",children:[e.jsx("option",{value:"all",children:"All Content"}),d.map(t=>e.jsx("option",{value:String(t.id),children:t.title},t.id))]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(E,{onClick:L,children:"Export PDF"}),e.jsx(E,{onClick:I,children:"Export CSV"}),e.jsx(E,{variant:"ghost",onClick:()=>alert("Email sharing not implemented."),children:"Share to Email"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsx(y,{className:"text-center",children:e.jsxs("div",{className:"stat",children:[e.jsx("div",{className:"stat-title",children:"Total Statements"}),e.jsx("div",{className:"stat-value",children:w.totalStatements})]})}),e.jsx(y,{className:"text-center",children:e.jsxs("div",{className:"stat",children:[e.jsx("div",{className:"stat-title",children:"Active Learners"}),e.jsx("div",{className:"stat-value",children:w.activeLearners})]})}),e.jsx(y,{className:"text-center",children:e.jsxs("div",{className:"stat",children:[e.jsx("div",{className:"stat-title",children:"Average Score"}),e.jsxs("div",{className:"stat-value",children:[w.averageScore.toFixed(2),"%"]})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-5 gap-6",children:[e.jsxs(y,{className:"lg:col-span-3",children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Engagement Over Time"}),e.jsx(P,{width:"100%",height:250,children:e.jsxs(X,{data:u,children:[e.jsx(T,{strokeDasharray:"3 3",stroke:"hsl(var(--b3))"}),e.jsx(M,{dataKey:"date",tick:{fill:"hsl(var(--bc) / 0.7)",fontSize:12}}),e.jsx(V,{tick:{fill:"hsl(var(--bc) / 0.7)",fontSize:12}}),e.jsx($,{contentStyle:{backgroundColor:"hsl(var(--b2))",border:"1px solid hsl(var(--b3))"}}),e.jsx(O,{}),e.jsx(B,{type:"monotone",dataKey:"Launched",stroke:"#8884d8"}),e.jsx(B,{type:"monotone",dataKey:"Completed",stroke:"#82ca9d"})]})})]}),e.jsxs(y,{className:"lg:col-span-2",children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Device Usage"}),e.jsx(P,{width:"100%",height:250,children:e.jsxs(H,{children:[e.jsx(G,{data:A,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",outerRadius:80,label:!0,children:A.map((t,a)=>e.jsx(Y,{fill:D[a%D.length]},`cell-${a}`))}),e.jsx($,{contentStyle:{backgroundColor:"hsl(var(--b2))",border:"1px solid hsl(var(--b3))"}}),e.jsx(O,{})]})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(y,{children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Quiz Score Distribution"}),e.jsx(P,{width:"100%",height:250,children:e.jsxs(Q,{data:k,children:[e.jsx(T,{strokeDasharray:"3 3",stroke:"hsl(var(--b3))"}),e.jsx(M,{dataKey:"name",tick:{fill:"hsl(var(--bc) / 0.7)",fontSize:12}}),e.jsx(V,{tick:{fill:"hsl(var(--bc) / 0.7)",fontSize:12}}),e.jsx($,{contentStyle:{backgroundColor:"hsl(var(--b2))",border:"1px solid hsl(var(--b3))"}}),e.jsx(q,{dataKey:"count",fill:"#8884d8",name:"Learners"})]})})]}),e.jsxs(y,{children:[e.jsx("h3",{className:"font-semibold mb-4",children:"Content Hotspots"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-green-400",children:"Most Completed"}),e.jsx("ul",{className:"mt-2 space-y-1 list-disc list-inside",children:C.mostCompleted.map(t=>e.jsxs("li",{children:[" ",t.title," ",e.jsxs("span",{className:"opacity-70",children:["(",t.rate.toFixed(0),"%)"]})," "]},t.title))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-red-400",children:"Least Completed"}),e.jsx("ul",{className:"mt-2 space-y-1 list-disc list-inside",children:C.leastCompleted.map(t=>e.jsxs("li",{children:[" ",t.title," ",e.jsxs("span",{className:"opacity-70",children:["(",t.rate.toFixed(0),"%)"]})," "]},t.title))})]})]})]})]})]})},Z=({allUsers:h,allContent:d})=>{const[p,i]=o.useState([]),[m,f]=o.useState(!1),[x,b]=o.useState({userId:"all",contentId:"all"});o.useEffect(()=>{(async()=>{f(!0);let c,v;x.userId!=="all"&&(c=h.find(u=>u.id===x.userId)),x.contentId!=="all"&&(v=d.find(u=>u.id===parseInt(x.contentId)));const w=await _({agent:c,activity:v});i(w),f(!1)})()},[x,h,d]);const g=()=>{var k,C,I,L,D,t,a;if(p.length===0){alert("No data to export.");return}const c=[["Timestamp","Actor Name","Actor Email","Verb","Activity Name","Activity ID","Success","Score","Response","Duration"].join(",")];for(const s of p){const n=[`"${new Date(s.timestamp).toLocaleString()}"`,`"${s.actor.name||""}"`,`"${s.actor.mbox||""}"`,`"${s.verb.display["en-US"]||s.verb.id}"`,`"${((C=(k=s.object.definition)==null?void 0:k.name)==null?void 0:C["en-US"])||""}"`,`"${s.object.id}"`,`"${((I=s.result)==null?void 0:I.success)??"N/A"}"`,`"${((D=(L=s.result)==null?void 0:L.score)==null?void 0:D.raw)??"N/A"}"`,`"${((t=s.result)==null?void 0:t.response)??""}"`,`"${((a=s.result)==null?void 0:a.duration)??"N/A"}"`];c.push(n.join(","))}const v=c.join(`
`),w=new Blob([v],{type:"text/csv;charset=utf-8;"}),u=document.createElement("a"),A=URL.createObjectURL(w);u.setAttribute("href",A),u.setAttribute("download","xapi_report.csv"),document.body.appendChild(u),u.click(),document.body.removeChild(u)},S=[{key:"actor",header:"User",render:r=>r.actor.name||r.actor.mbox},{key:"verb",header:"Action",render:r=>r.verb.display["en-US"]},{key:"object",header:"Object",render:r=>{var c,v;return((v=(c=r.object.definition)==null?void 0:c.name)==null?void 0:v["en-US"])||r.object.id}},{key:"timestamp",header:"Timestamp",render:r=>new Date(r.timestamp).toLocaleString()}];return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-between",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("select",{value:x.userId,onChange:r=>b(c=>({...c,userId:r.target.value})),className:"select select-bordered",children:[e.jsx("option",{value:"all",children:"All Users"}),h.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]}),e.jsxs("select",{value:x.contentId,onChange:r=>b(c=>({...c,contentId:r.target.value})),className:"select select-bordered",children:[e.jsx("option",{value:"all",children:"All Content"}),d.map(r=>e.jsx("option",{value:String(r.id),children:r.title},r.id))]})]}),e.jsx(E,{onClick:g,children:"Export CSV"})]}),m?e.jsx("div",{className:"text-center p-8",children:e.jsx("span",{className:"loading loading-lg"})}):e.jsx(J,{columns:S,data:p.map(r=>({...r,id:r.id||Math.random().toString()}))})]})},ee=({organizations:h})=>{const[d,p]=o.useState(""),i=o.useMemo(()=>h.find(m=>m.id===d),[h,d]);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"form-control w-full max-w-xs",children:[e.jsx("label",{htmlFor:"org-select",className:"label",children:e.jsx("span",{className:"label-text",children:"Select an Organization to View Report"})}),e.jsxs("select",{id:"org-select",value:d,onChange:m=>p(m.target.value),className:"select select-bordered",children:[e.jsx("option",{value:"",children:"-- Select Organization --"}),h.map(m=>e.jsx("option",{value:m.id,children:m.name},m.id))]})]}),i!=null&&i.powerbi_embed_url?e.jsx("div",{className:"card bg-base-200 shadow-xl overflow-hidden",style:{height:"calc(100vh - 20rem)"},children:e.jsx("iframe",{title:i.name,width:"100%",height:"100%",src:i.powerbi_embed_url,frameBorder:"0",allowFullScreen:!0})}):d?e.jsx(y,{children:e.jsxs("div",{className:"text-center p-8",children:[e.jsx("h2",{className:"text-xl font-bold",children:"Dashboard Not Available"}),e.jsxs("p",{className:"opacity-70 mt-2",children:["A Power BI dashboard has not been configured for ",i==null?void 0:i.name,"."]})]})}):null]})},ge=({analytics:h,cyberAnalytics:d,content:p,organizations:i,users:m})=>{const[f,x]=o.useState("xAPI Dashboard"),b=["xAPI Dashboard","xAPI Feed","Power BI"];return e.jsxs("div",{className:"animate-fade-in space-y-8",children:[e.jsx(z,{title:"Analytics",subtitle:"Deep dive into platform, learning, and business intelligence data."}),e.jsx("div",{className:"flex border-b border-border",children:b.map(g=>e.jsx("button",{onClick:()=>x(g),className:`px-4 py-2 text-sm font-medium ${f===g?"border-b-2 border-primary text-primary":"text-text-secondary hover:text-text-main"}`,children:g},g))}),e.jsxs("div",{className:"mt-6",children:[f==="xAPI Dashboard"&&e.jsx(W,{users:m,content:p}),f==="xAPI Feed"&&e.jsx(Z,{allUsers:m,allContent:p}),f==="Power BI"&&e.jsx(ee,{organizations:i})]})]})};export{ge as default};
